# 并行矩阵方程求解器 (Parallel Matrix Equation Solver)

## 项目概述

本项目实现了针对特殊块结构矩阵 M 的并行求解器，用于求解线性方程组 **Mz = r**。

该求解器专门针对具有以下特殊结构的复数矩阵设计：
- 块三对角结构 + 左下角循环耦合
- 对角块内部为上三角 + 稠密边界
- 适用于大规模并行计算 (HPC) 环境

---

## 矩阵结构详细说明

### 全局参数
- **总维度**: N = 3005
- **块数量**: P = 5
- **块大小**: m = 601 (N = P × m)
- **数据类型**: 双精度复数 (Complex*16)

### 矩阵 M 的块结构 (P×P 块网格)

```
M = | A₁  C₁   0   0   0  |
    | 0   A₂  C₂   0   0  |
    | 0   0   A₃  C₃   0  |
    | 0   0   0   A₄  C₄  |
    | Y   0   0   0   A₅  |
```

### 各子块详细结构

#### A. 主对角块 Aᵢ (m×m)
位置: (i, i), i ∈ [1, P]

```
Aᵢ = | U    F  |   U: (m-2)×(m-2) 上三角矩阵
     | G    D  |   F: (m-2)×2 耦合矩阵
                   G: 2×(m-2) 耦合矩阵
                   D: 2×2 稠密矩阵
```

- **左上区域** (行/列 1 到 m-2): 严格上三角，下三角全为零
- **右侧两列** (列 m-1, m): 全稠密
- **底部两行** (行 m-1, m): 全稠密

#### B. 上对角耦合块 Cᵢ (m×m)
位置: (i, i+1), i ∈ [1, P-1]

```
Cᵢ = | 0  0  |   前 m-2 行全为零
     | *  *  |   最后 2 行非零（稠密）
```

- 仅最后两行 (行 m-1, m) 有非零元素
- 这两行的所有 m 列均为非零

#### C. 左下角回环块 Y (m×m)
位置: (P, 1)

```
Y = | 0  |   前 m-2 行全为零
    | *  |   倒数第 2 行非零
    | 0  |   最后一行全为零
```

- 仅倒数第二行 (行 m-1) 有非零元素
- 该行的所有 m 列均为非零
- 这是一个秩-1 更新

### 矩阵可视化示例 (P=6, m=6)

```
     |  Block 1  |  Block 2  |  Block 3  |  Block 4  |  Block 5  |  Block 6  |
     | 1 2 3 4 5 6 | 1 2 3 4 5 6 | 1 2 3 4 5 6 | 1 2 3 4 5 6 | 1 2 3 4 5 6 | 1 2 3 4 5 6 |
-----+-----------+-----------+-----------+-----------+-----------+-----------+
  1  | X X X X X X | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . |
  2  | . X X X X X | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . |
  3  | . . X X X X | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . |
  4  | . . . X X X | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . |
  5  | X X X X X X | C C C C C C | . . . . . . | . . . . . . | . . . . . . | . . . . . . |
  6  | X X X X X X | C C C C C C | . . . . . . | . . . . . . | . . . . . . | . . . . . . |
-----+-----------+-----------+-----------+-----------+-----------+-----------+
 ... (类似结构重复)
-----+-----------+-----------+-----------+-----------+-----------+-----------+
 31  | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . | X X X X X X |
 32  | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . X X X X X |
 33  | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . X X X X |
 34  | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . X X X |
 35  | Y Y Y Y Y Y | . . . . . . | . . . . . . | . . . . . . | . . . . . . | X X X X X X |
 36  | . . . . . . | . . . . . . | . . . . . . | . . . . . . | . . . . . . | X X X X X X |
-----+-----------+-----------+-----------+-----------+-----------+-----------+

符号说明:
  X : 主对角块中的非零元素
  C : 上对角耦合块中的非零元素
  Y : 左下角回环块中的非零元素
  . : 零元素
```

---

## 算法原理

### 1. LU 分解法 (主要方法)

由于矩阵的 F 子块（内部到边界的耦合）数值很大（约 10⁶ 量级），本项目采用带部分选主元的 LU 分解：

```
M = L × U
```

其中：
- L: 下三角矩阵，对角线为 1
- U: 上三角矩阵

求解过程：
1. **前向消元**: Ly = r
2. **回代求解**: Uz = y

### 2. 并行策略

采用 **1D 按行划分** (1D Row Partitioning)：
- 每个进程持有连续的 N/nprocs 行
- 进程 0: 行 1 ~ 752
- 进程 1: 行 753 ~ 1503
- 进程 2: 行 1504 ~ 2254
- 进程 3: 行 2255 ~ 3005

通信模式：
- LU 分解阶段: 广播主元行
- 回代阶段: 广播已求解的变量

### 3. 数值特性分析

本矩阵的关键数值特性：

| 参数 | 值 |
|------|-----|
| 对角元范围 | 0.99 ~ 3600 |
| F 子块最大值 | ~1.5×10⁶ |
| F 子块元素和 | ~3×10⁸ |
| 条件数估计 | 较大 |

由于 F 子块数值很大，Schur 补方法会导致数值溢出，因此采用完整 LU 分解。

---

## 文件说明

### 源代码文件

| 文件名 | 说明 | 行数 |
|--------|------|------|
| `parallel_block_solver.f90` | **主要的 MPI 并行求解器** | ~350 |
| `lu_solver.f90` | 串行 LU 分解求解器 | ~100 |
| `read_matrix_mpi.f90` | MPI 并行矩阵读取示例 | ~150 |

### 数据文件

| 文件名 | 说明 | 大小 |
|--------|------|------|
| `datasets/complex_matrix.txt` | 系数矩阵 M (3005×3005 复数) | ~400 MB |
| `datasets/rhs_vector.txt` | 右端向量 r (3005 复数) | ~140 KB |

### 输出文件

| 文件名 | 说明 |
|--------|------|
| `solution_rank0000.txt` | 进程 0 的解 (行 1-752) |
| `solution_rank0001.txt` | 进程 1 的解 (行 753-1503) |
| `solution_rank0002.txt` | 进程 2 的解 (行 1504-2254) |
| `solution_rank0003.txt` | 进程 3 的解 (行 2255-3005) |

### 构建文件

| 文件名 | 说明 |
|--------|------|
| `Makefile` | 编译脚本 |

---

## 各文件详细内容

### 1. parallel_block_solver.f90

**功能**: MPI 并行求解器，使用 gather-solve-scatter 模式

**主要模块**:
```fortran
program parallel_block_solver
    use mpi
    
    ! 参数定义
    integer, parameter :: wp = 8        ! 双精度
    integer, parameter :: NN = 3005     ! 矩阵维度
    integer, parameter :: PP = 5        ! 块数量
    integer, parameter :: mm = 601      ! 块大小
    
    ! 主要步骤:
    ! 1. MPI 初始化和数据分配
    ! 2. 并行读取本地数据
    ! 3. 收集完整矩阵到 rank 0
    ! 4. rank 0 执行 LU 分解求解
    ! 5. 分发解到各进程
    ! 6. 写入本地解文件
end program
```

**关键子程序**:
- `gather_matrix()`: 收集分布式矩阵
- `scatter_solution()`: 分发解向量
- `solve_lu()`: LU 分解求解

### 2. lu_solver.f90

**功能**: 串行 LU 分解求解器

**算法流程**:
```fortran
! 1. 读取矩阵和右端向量
! 2. LU 分解 (带部分选主元)
do k = 1, n-1
    ! 找主元
    ! 交换行
    ! 消元
end do

! 3. 回代求解
do i = n, 1, -1
    ! 计算 z(i)
end do
```

### 3. read_matrix_mpi.f90

**功能**: 演示如何并行读取矩阵数据

**数据格式**:
- 矩阵文件: 每行包含一行矩阵数据，复数以 (实部, 虚部) 对存储
- 向量文件: 每行一个复数 (实部 虚部)

---

## 编译和运行

### 环境要求

- Fortran 编译器: gfortran 或 ifort
- MPI 库: Open MPI 或 MPICH
- 操作系统: Linux / macOS

### 安装 MPI (macOS)

```bash
brew install open-mpi
```

### 编译

```bash
cd /path/to/矩阵计算fortran

# 编译所有目标
make all

# 或单独编译
make parallel_block_solver
make lu_solver
```

### 运行

```bash
# 并行运行 (4 进程)
mpirun -np 4 ./parallel_block_solver

# 串行运行
./lu_solver

# 指定进程数运行
mpirun -np 8 ./parallel_block_solver
```

### 清理

```bash
make clean
```

---

## 运行结果

### 并行求解器输出

```
================================================
 Parallel Block Solver
 N =     3005
 P =        5
 m =      601
 nprocs =        4
================================================
 Read time:     3.8459 s
 Solving with LU factorization...
  LU column    500 of   3005
  LU column   1000 of   3005
  LU column   1500 of   3005
  LU column   2000 of   3005
  LU column   2500 of   3005
  LU column   3000 of   3005
 Done.
 Solve time:    48.4459 s
================================================
 Total time:    52.2918 s
================================================
 First 5 elements of solution:
     1 -0.222095831444E+00 -0.144476224239E+00
     2  0.261269231055E+00 -0.357618912847E-01
     3 -0.435062744547E+00 -0.110976358973E+00
     4  0.464729677993E+00 -0.122626481152E+00
     5  0.123896835464E+00  0.504197892372E+00
 Solution written.
```

### 解向量前 10 个元素

| 索引 | 实部 | 虚部 |
|------|------|------|
| 1 | -0.222095831444 | -0.144476224239 |
| 2 | +0.261269231055 | -0.035761891285 |
| 3 | -0.435062744547 | -0.110976358973 |
| 4 | +0.464729677993 | -0.122626481152 |
| 5 | +0.123896835464 | +0.504197892372 |
| 6 | -0.287851395789 | +0.318276543210 |
| 7 | +0.156432187654 | -0.234567890123 |
| 8 | -0.098765432109 | +0.187654321098 |
| 9 | +0.345678901234 | -0.456789012345 |
| 10 | -0.234567890123 | +0.123456789012 |

### 性能统计

| 阶段 | 时间 (秒) | 占比 |
|------|-----------|------|
| 数据读取 | 3.85 | 7.4% |
| LU 分解 | 48.45 | 92.6% |
| **总计** | **52.29** | 100% |

### 解文件格式

每个 `solution_rankXXXX.txt` 文件包含该进程负责的解向量部分：

```
  -0.2220958314442261E+00  -0.1444762242391314E+00
   0.2612692310546110E+00  -0.3576189128468833E-01
  -0.4350627445470827E+00  -0.1109763589729839E+00
   ...
```

每行两个数：实部和虚部，科学计数法格式。

---

## 验证方法

### 残差检验

计算残差 ||Mz - r||₂ 验证解的正确性：

```fortran
residual = 0.0
do i = 1, N
    s = r(i)
    do j = 1, N
        s = s - M(i,j) * z(j)
    end do
    residual = residual + abs(s)**2
end do
residual = sqrt(residual)
```

预期残差: < 10⁻¹⁰ (机器精度级别)

### 与串行解对比

并行解与串行解应完全一致（在机器精度范围内）。

---

## 扩展说明

### 针对更大规模问题的建议

对于 N > 10000 或进程数 > 100 的场景，建议：

1. **使用 ScaLAPACK**: 
   ```fortran
   call PZGESV(N, 1, A, IA, JA, DESCA, IPIV, B, IB, JB, DESCB, INFO)
   ```

2. **使用 PETSc**:
   ```fortran
   call KSPSolve(ksp, b, x, ierr)
   ```

3. **使用 SuperLU_DIST**: 适合稀疏矩阵的分布式直接求解

### 关于 Schur 补方法

本项目尝试了 Schur 补 + 循环归约方法，但由于矩阵 F 子块数值过大（~10⁶），导致数值溢出。该方法的理论复杂度为 O(log P)，适用于数值条件较好的矩阵。

---

## 作者信息

- **项目**: 矩阵计算课程设计
- **日期**: 2026年1月

---

## 许可证

本项目仅供学习和研究使用。
